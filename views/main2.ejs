<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <link href="main.css" rel="stylesheet" type="text/css">
</head>

<body>
    <h1>목표 달성 기록</h1>
    <div id='contain'>
        <div style="font-size: 300%; margin-left: 2%; margin-right: 1%;">날짜</div>
        <input type="date" id="calendar" onkeydown="return false" min="2021-01-01" max="2100-12-31">
        <div style="font-size: 300%; margin-left: 2%; margin-right: 1%;">친구</div>
        <select>
            <option>선택</option>
        </select>
        <button id='mode' onclick="change_mode()" style="margin-left: 2%;">수정</button>
    </div>
    <table border='1px' width='95%' cellspacing="0" cellpadding="0" style="margin-left: 2%;">
        <tr align="center" class="title">
            <td width="7%"></td>
            <td width="16%">목표</td>
            <td width="5%">달성</td>
            <td id="state_title" width="10%">실천 현황</td>
            <td id="control_title" class='control_td' width="10%"></td>
        </tr>
    </table>
    <h1 id='evaluation'></h1>
    </div>
</body>

<script>
    var selected_friend = "";
    let data = [
        ['토익', '0%', 'X'],
        ['푸쉬업', '66%', '30개/45개'],
        ['스터디', '90%', '1234567890 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27']
    ];

    // 임시 초기화
    $("#control_title").css('display', 'table-cell');
    $("#state_title").css('width', '10%');

    for (let i = 0; i < data.length; i++) {
        $('table').append(make_row(i, data));
    }
    $('table').append(make_row("avg"));

    for (let i = 0; i < data.length; i++) {
        $('table').append(make_row(i, data));
    }
    $('table').append(make_row("avg"));

    let mode = 1;

    function change_mode() {
        $('tr:not(.title)').remove();
        if (mode == 1) { // 현재 조회 모드라면
            $('#mode').text("저장");
            $('#mode').css("background", "#aef1a1");
            mode = 2; // 수정 모드로 전환

            $("#control_title").css('display', 'none');
            $("#state_title").css('width', '20%');

            for (let i = 0; i < data.length; i++) {
                $('table').append(make_row2(i, data));
            }
            $('table').append(make_row2('plus', data));
        } else { // 현재 수정 모드라면
            $('#mode').text("수정");
            $('#mode').css("background", "#FFD2D2");
            mode = 1; // 조회 모드로 전환

            $("#control_title").css('display', 'table-cell');
            $("#state_title").css('width', '10%');

            for (let i = 0; i < data.length; i++) {
                $('table').append(make_row(i, data));
            }
            $('table').append(make_row("avg"));

            for (let i = 0; i < data.length; i++) {
                $('table').append(make_row(i, data));
            }
            $('table').append(make_row("avg"));
        }
    }

    function remove(self) {
        let length = $('.row').length;
        let index = Number.parseInt($(self).attr('index'));

        let goal = $('#row' + index).find('input').val();
        if (goal != '' && !confirm(`'${goal}' 항목을 정말로 삭제하시겠습니까?`)) return;

        // row index 감소
        for (let i = index + 1; i < length; i++) {;
            let tr = $('#row' + i);
            $(tr).attr('id', 'row' + (i - 1));
            let td = $(tr).children()[0];
            let img1 = $(td).children()[0];
            let img2 = $(td).children()[1];
            $(img1).attr('index', i - 1);
            $(img2).attr('index', i - 1);
        }

        // plus index 감소
        let tr = $('#plus');
        let td = $(tr).children()[0];
        let div = $(td).children()[0];
        let img = $(div).children()[0];
        $(img).attr('index', length - 1);

        // html 제거
        $('#row' + index).remove();

        if (index == 0) { // 첫 줄에서 제거한 경우
            let name = `<td id="name" rowspan="${length + 1}"></td>`;
            if (length == 1) { // 한 줄만 남은 경우
                // plus에 name 추가
                let td = $('#plus').children()[0];
                $(td).before(name);
            } else {
                // row0에 name 추가
                let td = $('#row0').children()[0];
                $(td).before(name);
            }
        }

        // colspan 감소
        let td_ = $('#name');
        let span = Number.parseInt($(td_).attr('rowspan')) - 1;
        $(td_).attr('rowspan', span);
    }

    function add(self) {
        let index = Number.parseInt($(self).attr('index'));
        let length = $('.row').length;
        let table_row = "";

        if (index == 0) { // 첫 줄에서 추가한 경우
            // 삽입할 html 내용
            table_row = `
            <tr id='row${index}' class="row">
                <td id="name" rowspan="${length + 1}"></td>
                <td class='goal_td'>
                    <img index=${index} class="add_goal" onclick="add(this)" src='plus.png' />
                    <img index=${index} class="remove_goal" onclick="remove(this)" src='minus.png' />
                    <input class='goal' value="" placeholder="내용 입력" />
                </td>
                <td>
                    <div class='percentage'></div>
                </td>
                <td>
                    <div class='state'></div>
                </td>
            </tr>
        `;
            // row0의 name 제거
            $('#name').remove();
        } else { // 첫 줄이 아닌 줄에서 추가한 경우
            // 삽입할 html 내용
            table_row = `
            <tr id='row${index}' class="row">
                <td class='goal_td'>
                    <img index=${index} class="add_goal" onclick="add(this)" src='plus.png' />
                    <img index=${index} class="remove_goal" onclick="remove(this)" src='minus.png' />
                    <input class='goal' value="" placeholder="내용 입력" />
                </td>
                <td>
                    <div class='percentage'></div>
                </td>
                <td>
                    <div class='state'></div>
                </td>
            </tr>
        `;
        }

        // plus index 증가
        let tr = $('#plus');
        let td = $(tr).children()[0];
        let div = $(td).children()[0];
        let img = $(div).children()[0];
        $(img).attr('index', length + 1);

        if (index == length) { // 마지막 줄에서 추가한 경우
            // html 삽입
            $($('#plus')).before(table_row);
        } else { // 마지막 줄을 제외한 줄에서 추가한 경우
            // row index 증가
            for (let i = index; i < length; i++) {
                let tr = $('.row')[i];
                $(tr).attr('id', 'row' + (i + 1));
                let td = $(tr).children()[0];
                let img1 = $(td).children()[0];
                let img2 = $(td).children()[1];
                $(img1).attr('index', i + 1);
                $(img2).attr('index', i + 1);
            }

            // html 삽입
            if (index == 0) { // 첫 줄에 추가한 경우
                $($('#row1')).before(table_row);
            } else { // 첫 줄과 마지막 줄을 제외한 줄에서 추가한 경우
                $($('.row')[index]).before(table_row);
            }
        }

        // colspan 증가
        let td_ = $('#name');
        let span = Number.parseInt($(td_).attr('rowspan')) + 1;
        $(td_).attr('rowspan', span);
    }

    function make_row2(index, data) {
        let table_row;
        if (index == 'plus') {
            table_row = `
            <tr id='plus'>
                <td style='border-right: 0px; padding-left: 8px;'>
                    <div style='width:100%; height: 3rem; line-height: 3rem;'>
                        <img index=${data.length} class="add_goal" onclick="add(this)" src='plus.png' />
                    </div>
                </td>
                <td colspan='2' style='border-left: 0px;'></td>
            </tr>
            `;
        } else if (index == 0) {
            table_row = `
            <tr id='row${index}' class="row">
                <td id='name' rowspan='${data.length + 1}'></td>
                <td class='goal_td'>
                    <img index=${index} class="add_goal" onclick="add(this)" src='plus.png' />
                    <img index=${index} class="remove_goal" onclick="remove(this)" src='minus.png' />
                    <input class='goal' value="${data[index][0]}" placeholder="내용 입력" />
                </td>
                <td>
                    <div class='percentage'>${data[index][1]}</div>
                </td>
                <td>
                    <div class='state'>${data[index][2]}</div>
                </td>
            </tr>
            `;
        } else {
            table_row = `
            <tr id='row${index}' class="row">
                <td class='goal_td'>
                    <img index=${index} class="add_goal" onclick="add(this)" src='plus.png' />
                    <img index=${index} class="remove_goal" onclick="remove(this)" src='minus.png' />
                    <input class='goal' value="${data[index][0]}" placeholder="내용 입력" />
                </td>
                <td>
                    <div class='percentage'>${data[index][1]}</div>
                </td>
                <td>
                    <div class='state'>${data[index][2]}</div>
                </td>
            </tr>
        `;
        }
        return table_row;
    }

    function make_row(index, data) {
        let table_row;
        if (index == 'avg') {
            table_row = `
            <tr id='avg' class="row">
                <td>
                    <div class='goal'>계산</div>
                </td>
                <td>
                    <div class='percentage'>계산</div>
                </td>
                <td>
                    <div class='state'>계산</div>
                </td>
                <td class='control_td'>
                    <div class='control'></div>
                </td>
            </tr>
            `;
        } else if (index == 0) {
            table_row = `
            <tr id='row${index}' class="row">
                <td id='name' rowspan='${data.length + 1}'></td>
                <td>
                    <div class='goal'>${data[index][0]}</div>
                </td>
                <td>
                    <div class='percentage'>${data[index][1]}</div>
                </td>
                <td>
                    <div class='state'>${data[index][2]}</div>
                </td>
                <td class='control_td'>
                    <div class='control'></div>
                </td>
            </tr>
            `;
        } else {
            table_row = `
            <tr id='row${index}' class="row">
                <td>
                    <div class='goal'>${data[index][0]}</div>
                </td>
                <td>
                    <div class='percentage'>${data[index][1]}</div>
                </td>
                <td>
                    <div class='state'>${data[index][2]}</div>
                </td>
                <td class='control_td'>
                    <div class='control'></div>
                </td>
            </tr>
        `;
        }
        return table_row;
    }

    function number_to_string(number) {
        if (number < 10) return "0" + number;
        else return number;
    }

    function date_to_string(date) {
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var day = date.getDate();
        return year + "-" + number_to_string(month) + "-" + number_to_string(day);
    }

    function string_to_date(string) {
        return new Date(string.substr(0, 4), string.substr(5, 2) - 1, string.substr(8, 2));
    }

    function set_average() {
        var avg = 0;
        var cnt = 0;
        for (var i = 0; i < 7; i++) {
            var score = $($($($('#week' + i)).children()[3]).children()[0]).text();
            score = Number.parseInt(score);
            if (score || score == 0) {
                cnt++;
                avg += score;
            }
        }
        avg /= cnt;
        if (avg) $('#my_average').text(avg.toFixed(2) + "%");
    }

    function set_table(idx, goal, accomplish, score) {
        $($($($('#week' + idx)).children()[1]).children()[0]).text(goal);
        $($($($('#week' + idx)).children()[2]).children()[0]).text(accomplish);
        if (score != "") $($($($('#week' + idx)).children()[3]).children()[0]).text(score + "%");
    }

    function clear_table() {
        for (var i = 0; i < 7; i++) {
            for (var j = 0; j < 4; j++) {
                $($($($('#week' + i)).children()[j]).children()[0]).text("");
            }
        }
        $('#my_average').text("");
    }

    function set_friend_average() {
        var avg = 0;
        var cnt = 0;
        for (var i = 0; i < 7; i++) {
            var score = $($($($('#week' + i)).children()[6]).children()[0]).text();
            score = Number.parseInt(score);
            if (score || score == 0) {
                cnt++;
                avg += score;
            }
        }
        avg /= cnt;
        if (avg) $('#his_average').text(avg.toFixed(2) + "%");

        set_color();
    }

    function set_friend_table(idx, goal, accomplish, score) {
        $($($($('#week' + idx)).children()[4]).children()[0]).text(goal);
        $($($($('#week' + idx)).children()[5]).children()[0]).text(accomplish);
        if (score != "") $($($($('#week' + idx)).children()[6]).children()[0]).text(score + "%");
    }

    function clear_friend_table() {
        for (var i = 0; i < 7; i++) {
            for (var j = 4; j < 7; j++) {
                $($($($('#week' + i)).children()[j]).children()[0]).text("");
            }
        }
        $('#his_average').text("");
    }

    function set_color() {
        for (var i = 0; i < 7; i++) {
            var my_score = $($($($('#week' + i)).children()[3]).children()[0]).text();
            if (my_score == "") continue;
            var his_score = $($($($('#week' + i)).children()[6]).children()[0]).text();
            if (his_score == "") continue;
            var my_win = my_score.substr(0, my_score.length - 1) - his_score.substr(0, his_score.length - 1);
            var my_box = $($('#week' + i)).children()[3];
            var his_box = $($('#week' + i)).children()[6];
            if (my_win > 0) {
                my_box.style.backgroundColor = "#9cebaf";
                his_box.style.backgroundColor = "#FFD2D2";
            } else if (my_win < 0) {
                my_box.style.backgroundColor = "#FFD2D2";
                his_box.style.backgroundColor = "#9cebaf";
            } else {
                my_box.style.backgroundColor = "#9cebaf";
                his_box.style.backgroundColor = "#9cebaf";
            }
        }

        var my_score = $($($($('#average')).children()[1]).children()[0]).text();
        if (my_score == "") return;
        var his_score = $($($($('#average')).children()[2]).children()[0]).text();
        if (his_score == "") return;
        var my_win = my_score.substr(0, my_score.length - 1) - his_score.substr(0, his_score.length - 1);
        var my_box = $($('#average')).children()[1];
        var his_box = $($('#average')).children()[2];
        var evaluation = $('#evaluation');
        my_win = my_win.toFixed(2);
        if (my_win > 0) {
            my_box.style.backgroundColor = "#9cebaf";
            his_box.style.backgroundColor = "#FFD2D2";
            evaluation.text(`'<%=id%>'님이 '${selected_friend}'님보다 ${my_win}% 앞섭니다!`);
        } else
        if (my_win < 0) {
            my_box.style.backgroundColor = "#FFD2D2";
            his_box.style.backgroundColor = "#9cebaf";
            evaluation.text(`'<%=id%>'님이 '${selected_friend}'님보다 ${-my_win}% 뒤쳐집니다!`);
        } else {
            my_box.style.backgroundColor = "#9cebaf";
            his_box.style.backgroundColor = "#9cebaf";
            evaluation.text(`'<%=id%>'님과 '${selected_friend}'님이 서로 막상막하네요!`);
        }
    }

    function clear_color() {
        for (var i = 0; i < 7; i++) {
            var my_box = $($('#week' + i)).children()[3];
            var his_box = $($('#week' + i)).children()[6];
            my_box.style.backgroundColor = "white";
            his_box.style.backgroundColor = "white";
        }
        var my_box = $($('#average')).children()[1];
        var his_box = $($('#average')).children()[2];
        my_box.style.backgroundColor = "white";
        his_box.style.backgroundColor = "white";
        $('#evaluation').text("");
    }

    function load_me() {
        var load = 0;
        clear_table();
        var selected_date = string_to_date($('#calendar').val());
        var date = [new Date(selected_date), new Date(selected_date), new Date(selected_date), new Date(selected_date), new Date(selected_date), new Date(selected_date), new Date(selected_date)];
        date.forEach(function(ele, idx) {
            ele.setDate(selected_date.getDate() - 3 + idx);
            var name = '#week' + idx;
            var date_str = date_to_string(ele);
            $(name).find('#date').text(date_str);
            $.ajax({
                url: `/record?id=<%=id%>&date=${date_str}`,
                data: null,
                type: 'GET',
                success: function(data) {
                    load++;
                    if (data.result.length != 0) { // DB 데이터가 있는 경우
                        var goal = data.result[0].goal;
                        var accomplish = data.result[0].accomplish;
                        var score = data.result[0].score;
                        goal = goal.replace(/<br>/gi, '\n');
                        accomplish = accomplish.replace(/<br>/gi, '\n');
                        set_table(idx, goal, accomplish, score);
                    }
                    if (load == 7) {
                        load = 0;
                        set_average();
                    }
                },
                error: function(e) {
                    console.log(e);
                }
            });
        });
    }

    function load_friend() {
        var load = 0;
        clear_friend_table();
        var selected_date = string_to_date($('#calendar').val());
        var date = [new Date(selected_date), new Date(selected_date), new Date(selected_date), new Date(selected_date), new Date(selected_date), new Date(selected_date), new Date(selected_date)];
        date.forEach(function(ele, idx) {
            ele.setDate(selected_date.getDate() - 3 + idx);
            var name = '#week' + idx;
            var date_str = date_to_string(ele);
            $(name).find('#date').text(date_str);
            $.ajax({
                url: `/record?id=${selected_friend}&date=${date_str}`,
                data: null,
                type: 'GET',
                success: function(data) {
                    load++;
                    if (data.result.length != 0) { // DB 데이터가 있는 경우
                        var goal = data.result[0].goal;
                        var accomplish = data.result[0].accomplish;
                        var score = data.result[0].score;
                        goal = goal.replace(/<br>/gi, '\n');
                        accomplish = accomplish.replace(/<br>/gi, '\n');
                        set_friend_table(idx, goal, accomplish, score);
                    }
                    if (load == 7) {
                        load = 0;
                        set_friend_average();
                    }
                },
                error: function(e) {
                    console.log(e);
                }
            });
        });
    }
    /*
    $('#calendar').change(function() {
        clear_color();
        load_me();
        load_friend();
    });

    $('#myself').text("<%=id%>");
    $('select').change(function() {
        clear_color();
        selected_friend = $(this).children("option:selected").val();
        $('#friend').text(selected_friend);
        load_friend();
    });
    $.ajax({
        url: `/friend?id=
                <%=id%>`,
        type: 'GET',
        success: function(data) {
            data.result.forEach(function(friend) {
                $('select').append(`
                    <option>${friend.friend_id}</option>`);
            });
        },
        error: function(e) {
            console.log(e);
        }
    });
    $('#input').click(function() {
        window.location.href = '/input';
    });
    $('#calendar').val(date_to_string(new Date()));
    $('#calendar').trigger('change');
    */
</script>

</html>

</html>

</html>

</html>